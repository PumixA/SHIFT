name: CI Pipeline

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]

env:
  NODE_VERSION: "20"

jobs:
  # ============================================
  # Client (Next.js) - Lint, Type Check, Build
  # ============================================
  client-check:
    name: Client - Lint & Type Check
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./client

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: client/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint

      - name: Check TypeScript
        run: npx tsc --noEmit

      - name: Check formatting
        run: npm run format:check

  client-build:
    name: Client - Build
    runs-on: ubuntu-latest
    needs: client-check
    defaults:
      run:
        working-directory: ./client

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: client/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Cache Next.js build
        uses: actions/cache@v5
        with:
          path: |
            client/.next/cache
          key: ${{ runner.os }}-nextjs-${{ hashFiles('client/package-lock.json') }}-${{ hashFiles('client/**/*.ts', 'client/**/*.tsx') }}
          restore-keys: |
            ${{ runner.os }}-nextjs-${{ hashFiles('client/package-lock.json') }}-

      - name: Build
        run: npm run build

  # ============================================
  # Server (Express) - Lint, Type Check, Build
  # ============================================
  server-check:
    name: Server - Lint & Type Check
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./server

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: server/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma Client
        run: npx prisma generate

      - name: Check TypeScript
        run: npx tsc --noEmit

  server-build:
    name: Server - Build
    runs-on: ubuntu-latest
    needs: server-check
    defaults:
      run:
        working-directory: ./server

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: server/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma Client
        run: npx prisma generate

      - name: Build
        run: npm run build

  # ============================================
  # Tests Unitaires
  # ============================================
  test-unit:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: [client-check, server-check]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install client dependencies
        working-directory: ./client
        run: npm ci

      - name: Install server dependencies
        working-directory: ./server
        run: npm ci && npx prisma generate

      # Décommenter quand les tests sont configurés
      # - name: Run client tests
      #   working-directory: ./client
      #   run: npm test -- --coverage

      # - name: Run server tests
      #   working-directory: ./server
      #   run: npm test -- --coverage

      - name: Tests placeholder
        run: echo "Tests à configurer"

  # ============================================
  # Tests E2E (Playwright)
  # ============================================
  test-e2e:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: [client-build, server-build]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/dev'

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: shift_user
          POSTGRES_PASSWORD: shift_password
          POSTGRES_DB: shift_game
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Install dependencies
        run: |
          cd client && npm ci
          cd ../server && npm ci && npx prisma generate

      - name: Setup database
        working-directory: ./server
        run: npx prisma db push
        env:
          DATABASE_URL: postgresql://shift_user:shift_password@localhost:5432/shift_game

      # Décommenter quand les tests E2E sont configurés
      # - name: Start server
      #   working-directory: ./server
      #   run: npm run start &
      #   env:
      #     DATABASE_URL: postgresql://shift_user:shift_password@localhost:5432/shift_game
      #     PORT: 3001

      # - name: Start client
      #   working-directory: ./client
      #   run: npm run start &
      #   env:
      #     NEXT_PUBLIC_SOCKET_URL: http://localhost:3001

      # - name: Run E2E tests
      #   working-directory: ./client
      #   run: npx playwright test

      - name: E2E placeholder
        run: echo "Tests E2E à configurer"

  # ============================================
  # Analyse de Sécurité
  # ============================================
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: [client-check, server-check]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install client dependencies
        working-directory: ./client
        run: npm ci

      - name: Install server dependencies
        working-directory: ./server
        run: npm ci

      - name: Run npm audit (client)
        working-directory: ./client
        run: npm audit --audit-level=high || true

      - name: Run npm audit (server)
        working-directory: ./server
        run: npm audit --audit-level=high || true

      # CodeQL pour analyse statique
      # - name: Initialize CodeQL
      #   uses: github/codeql-action/init@v3
      #   with:
      #     languages: typescript

      # - name: Perform CodeQL Analysis
      #   uses: github/codeql-action/analyze@v3

  # ============================================
  # Version Check
  # ============================================
  version-check:
    name: Version Check
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check VERSION file
        run: |
          if [ ! -f VERSION ]; then
            echo "::error::VERSION file is missing!"
            exit 1
          fi

          VERSION=$(cat VERSION | tr -d '\n')
          echo "Current version: $VERSION"

          # Validate semantic versioning format
          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?$ ]]; then
            echo "::error::Invalid version format: $VERSION"
            echo "Expected format: MAJOR.MINOR.PATCH or MAJOR.MINOR.PATCH-PRERELEASE"
            exit 1
          fi

          echo "Version format is valid!"

  # ============================================
  # Résumé Final
  # ============================================
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [client-build, server-build, test-unit, security-scan]
    if: always()

    steps:
      - name: Check all jobs
        run: |
          if [[ "${{ needs.client-build.result }}" != "success" ]] || \
             [[ "${{ needs.server-build.result }}" != "success" ]] || \
             [[ "${{ needs.test-unit.result }}" != "success" ]] || \
             [[ "${{ needs.security-scan.result }}" != "success" ]]; then
            echo "::error::One or more CI jobs failed"
            echo "Client Build: ${{ needs.client-build.result }}"
            echo "Server Build: ${{ needs.server-build.result }}"
            echo "Unit Tests: ${{ needs.test-unit.result }}"
            echo "Security Scan: ${{ needs.security-scan.result }}"
            exit 1
          fi
          echo "All CI checks passed!"

name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

env:
  NODE_VERSION: "20"

jobs:
  # ============================================
  # Validate Release
  # ============================================
  validate:
    name: Validate Release
    runs-on: ubuntu-latest

    outputs:
      version: ${{ steps.version.outputs.version }}
      is_prerelease: ${{ steps.version.outputs.is_prerelease }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Extract version
        id: version
        run: |
          TAG_NAME="${GITHUB_REF#refs/tags/v}"
          echo "version=$TAG_NAME" >> $GITHUB_OUTPUT

          # Check if prerelease
          if [[ "$TAG_NAME" == *"-"* ]]; then
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
          else
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
          fi

          echo "Version: $TAG_NAME"

      - name: Validate version matches VERSION file
        run: |
          FILE_VERSION=$(cat VERSION | tr -d '\n')
          TAG_VERSION="${GITHUB_REF#refs/tags/v}"

          if [[ "$FILE_VERSION" != "$TAG_VERSION" ]]; then
            echo "::error::Version mismatch!"
            echo "VERSION file: $FILE_VERSION"
            echo "Git tag: $TAG_VERSION"
            echo ""
            echo "Please update the VERSION file before tagging."
            exit 1
          fi

          echo "Version validated: $FILE_VERSION"

  # ============================================
  # Build and Test
  # ============================================
  build:
    name: Build
    runs-on: ubuntu-latest
    needs: validate

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install and build client
        working-directory: ./client
        run: |
          npm ci
          npm run build

      - name: Install and build server
        working-directory: ./server
        run: |
          npm ci
          npx prisma generate
          npm run build

  # ============================================
  # Generate Changelog
  # ============================================
  changelog:
    name: Generate Changelog
    runs-on: ubuntu-latest
    needs: validate

    outputs:
      changelog: ${{ steps.changelog.outputs.changelog }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Generate changelog
        id: changelog
        run: |
          # Get the previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          CURRENT_TAG="${GITHUB_REF#refs/tags/}"

          echo "Previous tag: $PREV_TAG"
          echo "Current tag: $CURRENT_TAG"

          # Generate changelog from commits
          if [ -n "$PREV_TAG" ]; then
            COMMITS=$(git log --pretty=format:"- %s (%h)" $PREV_TAG..$CURRENT_TAG)
          else
            COMMITS=$(git log --pretty=format:"- %s (%h)")
          fi

          # Categorize commits
          FEATURES=$(echo "$COMMITS" | grep -E "^- feat" || true)
          FIXES=$(echo "$COMMITS" | grep -E "^- fix" || true)
          DOCS=$(echo "$COMMITS" | grep -E "^- docs" || true)
          REFACTOR=$(echo "$COMMITS" | grep -E "^- refactor" || true)
          CHORE=$(echo "$COMMITS" | grep -E "^- chore" || true)
          OTHER=$(echo "$COMMITS" | grep -vE "^- (feat|fix|docs|refactor|chore)" || true)

          # Build changelog
          CHANGELOG=""

          if [ -n "$FEATURES" ]; then
            CHANGELOG="$CHANGELOG## Features\n$FEATURES\n\n"
          fi

          if [ -n "$FIXES" ]; then
            CHANGELOG="$CHANGELOG## Bug Fixes\n$FIXES\n\n"
          fi

          if [ -n "$DOCS" ]; then
            CHANGELOG="$CHANGELOG## Documentation\n$DOCS\n\n"
          fi

          if [ -n "$REFACTOR" ]; then
            CHANGELOG="$CHANGELOG## Refactoring\n$REFACTOR\n\n"
          fi

          if [ -n "$CHORE" ]; then
            CHANGELOG="$CHANGELOG## Maintenance\n$CHORE\n\n"
          fi

          if [ -n "$OTHER" ]; then
            CHANGELOG="$CHANGELOG## Other Changes\n$OTHER\n\n"
          fi

          # Save to file for multi-line output
          echo -e "$CHANGELOG" > changelog.txt

          # Output for GitHub Actions
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          cat changelog.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

  # ============================================
  # Create GitHub Release
  # ============================================
  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [validate, build, changelog]

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: "SHIFT v${{ needs.validate.outputs.version }}"
          body: |
            # SHIFT v${{ needs.validate.outputs.version }}

            ${{ needs.changelog.outputs.changelog }}

            ---

            ## Installation

            ```bash
            git clone https://github.com/PumixA/SHIFT_PROJECT.git
            cd SHIFT_PROJECT

            # Client
            cd client && npm install && npm run build

            # Server
            cd ../server && npm install && npx prisma generate && npm run build
            ```

            ## Full Changelog

            See [CHANGELOG.md](https://github.com/PumixA/SHIFT_PROJECT/blob/main/CHANGELOG.md)
          draft: false
          prerelease: ${{ needs.validate.outputs.is_prerelease == 'true' }}
          generate_release_notes: true

  # ============================================
  # Deploy (placeholder for future)
  # ============================================
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [release]
    if: needs.validate.outputs.is_prerelease == 'false'
    environment: production

    steps:
      - name: Deployment placeholder
        run: |
          echo "Production deployment will be configured here"
          echo "Version: ${{ needs.validate.outputs.version }}"
          # Future: Deploy to production server

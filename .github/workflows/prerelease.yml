name: Pre-release

on:
  push:
    branches:
      - dev

env:
  NODE_VERSION: "20"

jobs:
  # ============================================
  # Check if Version Bump Needed
  # ============================================
  check-version:
    name: Check Version
    runs-on: ubuntu-latest

    outputs:
      should_release: ${{ steps.check.outputs.should_release }}
      new_version: ${{ steps.check.outputs.new_version }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Check for version changes
        id: check
        run: |
          # Get current version from VERSION file
          CURRENT_VERSION=$(cat VERSION | tr -d '\n')
          echo "Current version: $CURRENT_VERSION"

          # Check if this version tag already exists
          if git tag -l "v$CURRENT_VERSION-rc.*" | grep -q .; then
            # Get the latest RC number
            LATEST_RC=$(git tag -l "v$CURRENT_VERSION-rc.*" | sort -V | tail -1 | sed 's/.*-rc\.//')
            NEXT_RC=$((LATEST_RC + 1))
            NEW_VERSION="$CURRENT_VERSION-rc.$NEXT_RC"
          else
            NEW_VERSION="$CURRENT_VERSION-rc.1"
          fi

          echo "New version: $NEW_VERSION"
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "should_release=true" >> $GITHUB_OUTPUT

  # ============================================
  # Run Full CI
  # ============================================
  ci:
    name: CI Pipeline
    runs-on: ubuntu-latest
    needs: check-version

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install and check client
        working-directory: ./client
        run: |
          npm ci
          npm run lint
          npx tsc --noEmit
          npm run format:check
          npm run build

      - name: Install and check server
        working-directory: ./server
        run: |
          npm ci
          npx prisma generate
          npx tsc --noEmit
          npm run build

  # ============================================
  # Create Pre-release Tag
  # ============================================
  tag-prerelease:
    name: Tag Pre-release
    runs-on: ubuntu-latest
    needs: [check-version, ci]
    if: needs.check-version.outputs.should_release == 'true'
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Create and push tag
        run: |
          NEW_VERSION="${{ needs.check-version.outputs.new_version }}"

          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

          git tag -a "v$NEW_VERSION" -m "Pre-release v$NEW_VERSION"
          git push origin "v$NEW_VERSION"

          echo "Created tag: v$NEW_VERSION"

  # ============================================
  # Deploy to Staging (placeholder)
  # ============================================
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [check-version, tag-prerelease]
    environment: staging

    steps:
      - name: Deployment placeholder
        run: |
          echo "Staging deployment will be configured here"
          echo "Version: ${{ needs.check-version.outputs.new_version }}"
          # Future: Deploy to staging/preprod server
